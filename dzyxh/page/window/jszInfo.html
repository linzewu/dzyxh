<div class="easyui-layout" data-options="fit:true">
	<div data-options="region:'center'"
		style="padding: 5px; background: #eee;">

		<fieldset class="base_fl">
			<legend>查询条件</legend>
			<form id="drvBaseSelectForm">
				<table class="base_table" id="drvBaseSelect"
					style="min-width: 460px;" cellpadding="0" cellspacing="0">
					<tr>
						<td class="info_title"><label for="date">姓名:</label></td>
						<td class="info"><input name="xm" /></td>
						<td class="info_title"><label for="date">身份证号:</label></td>
						<td class="info"><input name="sfzmhm" /></td>
					</tr>
					<!-- <tr>
					<td class="info_title"><label for="date">证件名称:</label></td>
					<td class="info"><select name="sfzmmc" style="width: 172px"></select></td>
					<td class="info_title"><label for="date">证件号码:</label></td>
					<td class="info"><input name="sfzmhm" /></td>
				</tr> -->
					<tr>
						<td class="info_title"><label for="date">期号:</label></td>
						<td class="info"><input name="qh" /></td>
						<td class="info_title"><label for="date">驾校:</label></td>
						<td class="info"><select name="jxdm" style="width: 172px"></select></td>
					</tr>
					<tr>
						<td class="info_title"><label for="date">时间:</label></td>
						<td class="info" colspan="3"><input type="text"
							readonly="readonly" style="width: 100px" onFocus="WdatePicker()"
							class="Wdate" name="cjsjks" />到<input type="text"
							readonly="readonly" style="width: 100px" onFocus="WdatePicker()"
							class="Wdate" name="cjsjjs" /></td>
					</tr>
				</table>
			</form>
			<div style="text-align: right;">
				<a href="#" class="easyui-linkbutton c6"
					style="width: 80px; margin-top: 6px;" onclick="selectBase();">查询</a>
				<a href="#" class="easyui-linkbutton c2"
					style="width: 80px; margin-top: 6px;" onclick="windowClose();">退出</a>
			</div>
		</fieldset>
		<fieldset class="base_fl">
			<legend>驾驶人信息</legend>
			<table class="base_table"
				style="min-width: 460px; min-height: 380px; margin: 5px 5px 5px 5px"
				cellpadding="0" cellspacing="0">
				<tr>
					<td class="info_title"><label>姓名:</label></td>
					<td class="info" id="xm"></td>
					<td class="info_title"><label>性别:</label></td>
					<td class="info" id="xb"></td>
				</tr>
				<tr>
					<td class="info_title"><label>证件名称:</label></td>
					<td class="info" id="sfzmmc"></td>
					<td class="info_title"><label>证件号码:</label></td>
					<td class="info" id="sfzmhm"></td>

				</tr>
				<tr>
					<td class="info_title"><label>出生日期:</label></td>
					<td class="info" id="csrq"></td>
					<td class="info_title"><label>国籍:</label></td>
					<td class="info" id="gj"></td>
				</tr>
				<tr>

					<td class="info_title"><label>联系电话:</label></td>
					<td class="info" id="lxdh"></td>
					<td class="info_title"><label>电子邮箱:</label></td>
					<td class="info" id="dzyx"></td>
				</tr>
				<tr>
					<td class="info_title"><label>期号:</label></td>
					<td class="info" id="qh"></td>
					<td class="info_title"><label>驾校:</label></td>
					<td class="info" id="jxdm"></td>
				</tr>
				<tr>
					<td class="info_title"><label>登记住所行政区划:</label></td>
					<td class="info" id="djzsxzqh"></td>
					<td class="info_title"><label>登记住所详细地址:</label></td>
					<td class="info" id="djzsxxdz"></td>
				</tr>
				<tr>
					<td class="info_title"><label>联系住所行政区划:</label></td>
					<td class="info" id="lxzsxzqh"></td>
					<td class="info_title"><label>联系住所详细地址:</label></td>
					<td class="info" id="lxzsxxdz"></td>
				</tr>
				<tr>
					<td class="info_title"><label>邮政编码:</label></td>
					<td class="info" id="lxzsyzbm"></td>
					<td class="info_title"><label>是否本地:</label></td>
					<td class="info" id="sfbd"></td>
				</tr>
				<tr>
					<td class="info_title"><label>暂住证明:</label></td>
					<td class="info" id="zzzm"></td>
					<td class="info_title"><label>更新时间:</label></td>
					<td class="info" id="gxsj"></td>
				</tr>

			</table>
		</fieldset>
	</div>
	<div data-options="region:'east',title:''"
		style="width: 60%; border: 0">
		<div class="easyui-layout" data-options="fit:true">
			<div data-options="region:'center'" style="padding: 0px;"
				id="businessInfoBase">
				<div id="businessInfo"></div>
			</div>
		</div>
	</div>
</div>
<div id="select_window" style="width: 60%; height: 40%"
	class="easyui-window"
	data-options="title:'选择驾驶人',modal:true,closed:true"></div>
<script type="text/javascript">
	comm.createBaseSelect("#drvBaseSelect select[name=jxdm]", "jxdm", "请选择");

	//业务数据缓存
	var temp = {}, fulfilLoad = {};

	function addTjbTab(sfzmhm) {
		//图片信息
		var tab = $('<div class="products"><ul></ul></div>');
		var tabs = $("#businessInfo");
		var options = "<div data-options=\"title:'体检表'\"><div class='products' id='tjbTab'></div></div>";
		tabs.append(options);
		/* 	tab
		.append("<li><a href=\"#\" class=\"item\"> <img src=\"exa/getExaPic?"
				+ params
				+ "\" /><div><p>体检表</p></div></a></li>"); */
		var table = $("#tjbTab");
		$
				.post(
						"exa/getDriExaminations",
						{
							"sfzmhm" : sfzmhm
						},
						function(data, status) {
							if (status == "success") {
								if (data.rows.length == 0) {
									var tab = $('<div class="products" align="center">无体检数据</div>');
									table
											.append($(
													'<fieldset class="base_fl"><legend>体检图片</legend></fieldset>')
													.append(tab));
								} else {
									//图片信息
									var tab = $('<div class="products"><ul></ul></div>');

									/* 	tab
												.append("<li><a href=\"#\" class=\"item\"> <img src=\"exa/getExaPic?"
														+ params
														+ "\" /><div><p>体检表</p></div></a></li>"); */
									$
											.each(
													data.rows,
													function(i, val) {
														var params = "id="
																+ val.id;
														tab
																.append("<li><a href=\"#\" class=\"item\"> <img src=\"img/getDriBaseById?id="
																		+ val.sqbtpId
																		+ "\" /><div><p>"
																		+ val.tjrq
																		+ "</p></div></a></li>");
													});
									table
											.append($(
													'<fieldset class="base_fl"><legend>体检图片</legend></fieldset>')
													.append(tab));
									//绑定图片单击事件
									$(".products img")
											.bind(
													"click",
													function() {
														onClickPic($(this)
																.attr("src"));
													});
								}
							}
						});

	}
	// 创建业务信息标签页
	function addTabs(rows) {
		var tabs = $("#businessInfo");

		temp = {}, fulfilLoad = {};
		$.each(rows, function(i, val) {
			var options = "<div data-options=\"title:'"
					+ comm.getParamNameByValue("ywlx", val.ywlx)
					+ "'\"><div class='products'></div></div>";
			tabs.append(options);
			if (!val.dabh) {
				val["dabh"] = "";
			}
			if (!val.sqrq) {
				val["sqrq"] = "";
			}
			if (!val.sqyq) {
				val["sqyq"] = "";
			}
			if(!val.lsh){
				val["lsh"] = "";
			}
			temp[i] = val;
		});
		//添加事件
		$('#businessInfo')
				.tabs(
						{
							border : false,
							onSelect : function(title, index) {
								/*  	alert(JSON.stringify(temp[index]) ); */
								if (index <= 0) {
									return;
								}
								//已加载不再加载
								if (!fulfilLoad[index - 1]) {
									//驾驶人信息
									var data = temp[index - 1], table = $('<div><fieldset class="base_fl"><legend>业务信息</legend><table class="base_table" cellpadding="0" cellspacing="0"><tr><td class="info_title"><label >业务类型:</label></td><td class="info" id="">'
											+ comm.getParamNameByValue("ywlx",
													data.ywlx)
											+ '</td><td class="info_title"><label >流水号:</label></td><td class="info" id="">'
											+ data.lsh
											+ '</td></tr>'
											+ '<tr><td class="info_title"><label >档案编号:</label></td><td class="info" id="">'
											+ data.dabh
											+ '</td><td class="info_title"><label >申请日期:</label></td><td class="info" id="">'
											+ data.sqrq
											+ '</td></tr>'
											+ '<tr><td class="info_title"><label >申请原因:</label></td><td class="info" id="" colspan="3">'
											+ data.sqyq
											+ '</td></tr>'
											+ '</table></fieldset></div>');

									//图片信息
									var tab = $('<div class="products"><ul></ul></div>');
									var params = "";
									if (data.lsh && data.lsh.length > 0) {
										//使用流水号查询
										params += "lsh=" + data.lsh;
									} else {
										//身份证、期号、驾校代码
										if (data.id.sfzmhm) {
											params += "id.sfzmhm="
													+ data.id.sfzmhm + "&";
										}
										if (data.id.qh) {
											params += "id.qh=" + data.id.qh
													+ "&";
										}
										if (data.id.jxdm) {
											params += "id.jxdm=" + data.id.jxdm
													+ "&";
										}
									}
									tab
											.append("<li><a href=\"#\" class=\"item\"> <img src=\"img/getDriBaseById?id="
													+ data.jdcjszsqbzp
													+ "\" /><div><p>申请表</p></div></a></li>");
									/* 	tab
												.append("<li><a href=\"#\" class=\"item\"> <img src=\"exa/getExaPic?"
														+ params
														+ "\" /><div><p>体检表</p></div></a></li>"); */
									var picIds = data.picIds;
									$
											.each(
													picIds,
													function(i, val) {
														tab
																.append("<li><a href=\"#\" class=\"item\"> <img src=\"img/getDriBaseById?id="
																		+ val
																		+ "\" /><div><p>照片</p></div></a></li>");
													});
									table
											.append($(
													'<fieldset class="base_fl"><legend>档案图片</legend></fieldset>')
													.append(tab));
									//获取当前选择页
									var current_tab = $('#businessInfo').tabs(
											'getSelected');
									//更新面板数据
									$('#businessInfo').tabs('update', {
										tab : current_tab,
										options : {
											content : table
										}
									});
									current_tab.panel('refresh');
									//绑定图片单击事件
									$(".products img")
											.bind(
													"click",
													function() {
														onClickPic($(this)
																.attr("src"));
													});
									//设置页面已加载标志
									fulfilLoad[index - 1] = true;
								}
							}
						});
	}
	//加载业务信息标签页
	function loadApply(sfzmhm) {
		//	$("#businessInfo").html("");
		$.post("apply/getApplyInfos", {
			'id.sfzmhm' : sfzmhm
		}, function(data, status) {
			if (status == "success") {
				addTabs(data.rows);
			}
		});
	}
	//关闭窗口
	function windowClose() {
		$('#comm_window').window('close'); // close a window
	}
	function selectBase() {
		$.post("dbc/getDriBases", serializeObject($("#drvBaseSelectForm")),
				function(data, status) {
					if (status == "success") {
						if (data.total == 0) {
							alert("没有找到符合条件的数据");
						} else if (data.total == 1) {
							initEditAttr(data.rows[0].sfzmhm);
						} else {
							$("#select_window").window('open').window(
									'refresh',
									"/dzyxh/page/window/jszSelect.html"); // open a window
						}
					}
				});

	}
	function select_windowClose() {
		$('#select_window').window('close'); // close a window
	}
	function init() {
		var row = $("#drvBaseManager").datagrid("getSelected");
		if (!row) {
			$.messager.alert("提示", "请选择一行信息！", "info");
			return;
		} else {
			initEditAttr(row.sfzmhm);
		}
	}
	function initEditAttr(sfzmhm) {
		if (!sfzmhm) {
			$.messager.alert("提示", "请选择一行信息！", "info");
			return;
		} else {
			$.post("dbc/getDriBaseById", {
				"sfzmhm" : sfzmhm
			}, function(data, status) {
				if (status == "success") {
					$("#sfzmhm").text(
							comm.getParamNameByValue("sfzmhm", data.sfzmhm));
					$("#sfzmmc").text(data.sfzmmc);
					$("#xm").text(data.xm);
					$("#xb").text(comm.getParamNameByValue("xb", data.xb));
					$("#csrq").text(data.csrq);
					$("#gj").text(data.gj);
					$("#djzsxzqh").text(data.djzsxzqh);
					$("#djzsxxdz").text(data.djzsxxdz);
					$("#lxzsxzqh").text(data.lxzsxzqh);
					$("#lxzsxxdz").text(data.lxzsxxdz);
					$("#lxzsyzbm").text(data.lxzsyzbm);
					$("#lxdh").text(data.lxdh);
					$("#zzzm").text(data.zzzm);
					if(data.gxsj!="null"){
						$("#gxsj").text(data.gxsj);
					}
				
					$("#sfbd").text(data.sfbd);
					$("#sjhm").text(data.sjhm);
					$("#dzyx").text(data.dzyx);
					$("#qh").text(data.qh);
					$("#jxdm")
							.text(comm.getParamNameByValue("jxdm", data.jxdm));
					//重构标签页
					var businessInfoBase = $("#businessInfoBase");
					businessInfoBase.html("");
					var tabs = $("<div id=\"businessInfo\"></div>");
					businessInfoBase.append(tabs);
					addTjbTab(data.sfzmhm);
					loadApply(data.sfzmhm);
				}
			});
		}
	}

	//将表单序列化
	function serializeObject(form) {
		var o = {};
		$.each(form.serializeArray(), function(index) {
			if (o[this['name']]) {
				o[this['name']] = o[this['name']] + "," + this['value'];
			} else {
				o[this['name']] = this['value'];
			}
		})
		return o;
	}
	init();
	//openMask();
</script>

<style type="text/css">
.products {
	overflow: auto;
	height: 100%;
	background: #fafafa;
}

.products ul {
	list-style: none;
	margin: 0;
	padding: 0px;
}

.products li {
	display: inline;
	float: left;
	margin: 8px;
}

.item {
	display: block;
	text-decoration: none;
}

.item img {
	border: 1px solid #333;
	width: 140px;
	height: 80px;
}

.item p {
	margin: 0;
	font-weight: bold;
	text-align: center;
	color: #c3c3c3;
}

.cart {
	float: right;
	position: relative;
	width: 260px;
	height: 100%;
	background: #ccc;
	padding: 0px 10px;
}

.ctitle {
	text-align: center;
	color: #555;
	font-size: 18px;
	padding: 10px;
}
</style>