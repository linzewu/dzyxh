<div data-options="fit:true" id="userPage" class="easyui-layout">
	<div data-options="region:'center'" id="winList">
		<div class="easyui-tabs" data-options="fit:true" id="win-tabs">
			<div data-options="title:'窗口设备列表'">
				<table id="winManager"
					data-options="url:'win/getWins',singleSelect:true,toolbar:winManagerToolbar,pagination:true">
					<thead>
						<tr>
							<th data-options="field:'name'" style="width: 200px;">窗口设备名称</th>
							<th data-options="field:'ip'" style="width: 100px;">ip</th>
							<th data-options="field:'status'" style="width: 100px;">状态</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>


<div id="winManagerToolbar" class="list-query-base">
	<div>
		<a href="#" class="easyui-linkbutton"
			data-options="iconCls:'icon-add',plain:true"
			onclick="comm.createTab('#win-tabs','添加窗口设备','page/window/WinInfo.html')">添加窗口设备</a>
		<a href="#" class="easyui-linkbutton"
			data-options="iconCls:'icon-edit',plain:true"
			onclick="comm.createTab('#win-tabs','编辑窗口设备','page/window/WinInfo.html')">编辑窗口设备</a>
		<a href="#" class="easyui-linkbutton"
			data-options="iconCls:'icon-remove',plain:true"
			onclick="deleteUser()">删除窗口设备</a>
	</div>
	<div>
		<label>设备名称:</label><input name="name"> <label>ip:</label><input
			name="ip"> <label>状态:</label><select name="status"></select>
		<a href="#" class="easyui-linkbutton"
			data-options="iconCls:'icon-search'" onclick="queryUser()">查询</a>
	</div>
</div>

<script type="text/javascript">
	function deleteUser() {

		var row = $("#userManager").datagrid("getSelected");

		if (!row) {
			$.messager.alert("提示", "请选择删除的用户！", "info");
			return;
		} else {
			$.messager.confirm("确认", "您是否确认删除该用户？", function(r) {

				if (r) {
					$.messager.progress({
						"title" : "提示",
						"msg" : "数据删除中..."
					});

					$.post(
							"user/delete",
							row,
							function(data) {
								if (data.state == 1) {
									$.messager.alert("提示", "用户删除成功！", "info",
											function() {
												$("#userManager").datagrid(
														"reload");
											});
								} else {
									$.messager.alert("提示", data.message,
											"error", function() {
												$("#userManager").datagrid(
														"reload");
											});
								}
							}).error(function() {
						$.messager.alert("错误", "系统错误，请联系管理员！", "error");
					}).complete(function() {
						$.messager.progress("close");
					});
				}

			})
		}

	}

	function passwordReset() {

		var row = $("#userManager").datagrid("getSelected");

		if (!row) {
			$.messager.alert("提示", "请选择重置密码的用户！", "info");
			return;
		} else {
			$.messager.confirm("确认", "您是否确认重置该用户密码？", function(r) {

				if (r) {
					$.messager.progress({
						"title" : "提示",
						"msg" : "处理中..."
					});

					$.post(
							"user/passwordReset",
							row,
							function(data) {
								if (data.state == 1) {
									$.messager.alert("提示", "密码重置成功！", "info",
											function() {
												$("#userManager").datagrid(
														"reload");
											});
								} else {
									$.messager.alert("提示", data.message,
											"error", function() {
												$("#userManager").datagrid(
														"reload");
											});
								}
							}).error(function() {
						$.messager.alert("错误", "系统错误，请联系管理员！", "error");
					}).complete(function() {
						$.messager.progress("close");
					});
				}

			})
		}

	}

	function deptFormatter(value, row, index) {
		return $("#dept-list").tree("find", value).text;
	}

	function queryUser() {

		var param = {};

		var yhm = $("#userManagerToolbar input[name=yhm]").val();

		var yhxm = $("#userManagerToolbar input[name=yhxm]").val();

		var sfzh = $("#userManagerToolbar input[name=sfzh]").val();

		var son = $("#userManagerToolbar input[name=son]").is(':checked');

		if (son) {
			param.seq = 1;
		}

		param.yhm = yhm;

		param.yhxm = yhxm;

		param.sfzh = sfzh;

		var node = $("#dept-list").tree("getSelected");

		param.bmdm = node.id;

		$("#winManager").datagrid("reload", param);

	}

	$(function() {
		loadTree();
	});

	function depts2Node(data) {
		var roots = [];
		for ( var i in data) {
			if (data[i].sjbmdm == null || data[i].sjbmdm == "") {
				var node = {};
				node.id = data[i].bmdm;
				node.text = data[i].bmmc;
				node.data = data[i];
				setChildrenNode(data, node);
				roots.push(node);
			}
		}
		return roots;
	}

	function setChildrenNode(data, node) {
		var children = [];
		for ( var i in data) {
			if (node.id == data[i].sjbmdm) {
				var child = {};
				child.id = data[i].bmdm;
				child.text = data[i].bmmc;
				child.data = data[i];
				setChildrenNode(data, child);
				children.push(child);
				node.children = children;
			}
		}
	}

	function loadTree(selectNodeId) {
		$.messager.progress({
			"title" : "提示",
			"msg" : "数据加载中..."
		});
		$.post("dept/getDepts", function(data) {
			var nodes = depts2Node(data);
/* 
			$("#dept-list").tree({
				data : nodes,
				onClick : function() {
					queryUser();
				}
			}); */

			$("#winManager").datagrid({
				queryParams : {
					bmdm : nodes[0].id
				}
			});

		}).complete(function() {
			$.messager.progress("close");
			var node = $('#dept-list').tree("getRoot");
			$('#dept-list').tree('select', node.target);
		});
	}
</script>
